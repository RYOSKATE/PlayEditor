
@*
* This template takes a single argument, a String containing a
* message to display.
*@
@(stackData:String,debugState:String,output:String)

@*
* Call the `main` template with two arguments. The first
* argument is a `String` with the title of the page, the second
* argument is an `Html` object containing the body of the page.
*@
@main("Welcome to Play") {
    @*
    * Get an `Html` object by calling the built-in Play welcome
    * template and passing a `String` message.
    *@
    @*
    @play20.welcome(message, style = "Scala")
    *@
    <div clsee="row">
        CodeArea(ACE)
        <div class="btn-group">
            <div class="btn-group">
                <button class="btn btn-default dropdown-toggle" data-toggle="dropdown"><i class="glyphicon glyphicon-search"></i> <span class="caret"></span></button>
                <ul class="dropdown-menu" id="font-size">
                    <li><a href="#" data-size="10">小さい</a></li>
                    <li><a href="#" data-size="12">普通</a></li>
                    <li><a href="#" data-size="14">大きい</a></li>
                </ul>
            </div>
            @*<button id="bold" class="btn btn-default"><i class="glyphicon glyphicon-bold"></i></button>*@
            @*<button id="save" class="btn btn-default"><i class="glyphicon glyphicon-floppy-save"></i></button>*@
            @*<button id="load" class="btn btn-default"><i class="glyphicon glyphicon-folder-open"></i></button>*@
            <button id="compile" class="btn btn-default"><i class="glyphicon glyphicon-repeat"></i></button> @*コンパイルしてメッセージ出力*@
            <button id="debug" class="btn btn-default"><i class="glyphicon glyphicon-play"></i></button>@*コンパイル済みならデバッグ開始*@
            <button id="exec" class="btn btn-default"><i class="glyphicon glyphicon-forward"></i></button> @*コンパイル済みなら実行*@
            <button id="step" class="btn btn-default"><i class="glyphicon glyphicon-arrow-down"></i></button>@*デバッグ開始済みならステップ*@
            <button id="stop" class="btn btn-default"><i class="glyphicon glyphicon-stop"></i></button>@*デバッグ中なら停止*@
        </div>
    </div>
    <div clsee="row">
        <div class="col-lg-6 col-md-6">
            DebugStatus:@Html(debugState)
            <div id="editorMain" style="height: 600px"></div>
        </div>
        <div class="col-lg-6 col-md-6">
            output
            <div id="output" style="height: 100px"></div>
            <canvas id="display" width="600px" height="720px"></canvas>
        </div>

        <div class="col-lg-12 col-md-12">
            処理の流れ<br>
            実行ボタン：JavaScriptでイベント取得。エディタ上のテキストを取得。Fromの形でPOST(JavaScript)<br>
            コントローラはポストされたデータを取得。アクション関数で文字列の処理など。(Scala,String)ビューにセット。<br>
            ビュー：生文字を取得(改行文字に注意)。JavaScriptでコメント文字など操作してセット。<br>
        </div>
    </div>
    <script src="@routes.Assets.versioned("javascripts/visualizer.js")" type="text/javascript"></script>
    <script>
            function createEditor(idName,canWrite,initText) {
                var editor = ace.edit(idName);
                if (canWrite) {
                    editor.$blockScrolling = Infinity;
                    editor.setOptions({
                        enableBasicAutocompletion: true,//基本的な自動補完
                        enableSnippets: true,//スニペット
                        enableLiveAutocompletion: true//ライブ補完
                    });
                }
                editor.setTheme("ace/theme/monokai");
                editor.getSession().setMode("ace/mode/c_cpp");//シンタックスハイライトと自動補完
                //editor.getSession().setUseWrapMode(true);//true:折り返し、false:横スクロールバー


                $('#font-size').click(function (e) {
                    editor.setFontSize($(e.target).data('size'));
                });

                editor.setReadOnly(!canWrite);
                if (canWrite) {

                    function send(sendText,action,method){
                        var form = document.createElement('form');
                        document.body.appendChild(form);
                        var input = document.createElement('input');
                        input.setAttribute('type', 'hidden');
                        input.setAttribute('name', 'name');
                        localStorage.text = sendText;
                        input.setAttribute('value', sendText);
                        form.appendChild(input);
                        form.setAttribute('action', '/visualizer'+action);
                        form.setAttribute('method', method);
                        form.submit();

                    }
                    $('#compile').click(function (e) {
                        send(editor.getValue(),'/compile','POST');
                        localStorage.line = 0;
                        localStorage.compile = "true";

                    });
                    $('#debug').click(function (e) {
                        send(editor.getValue(),'/debug','POST');
                        localStorage.line = 0;
                        localStorage.debug="true";
                    });

                    $('#exec').click(function (e) {
                        send(editor.getValue(),'/exec','POST');
                        localStorage.debug="true";
                    });

                    $('#step').click(function (e) {
                        send(editor.getValue(),'/step','POST');
                        localStorage.debug="true";
                    });
                    $('#stop').click(function (e) {
                        send(editor.getValue(),'/stop','POST');
                        localStorage.line = 0;
                    });
                }

                if (initText != '')
                    editor.setValue(initText, -1);
                return editor;
            }
            /*
             var mes =`@Html(debugState)`;
             var mes2 = '// '+ mes.replace( /<br>/g , `
             //`) ;
             */
            var editor = createEditor('editorMain',true,localStorage.text);
            var outputEditor = ace.edit("output");
            outputEditor.setReadOnly(true);
            outputEditor.setTheme("ace/theme/terminal");

            //createEditor('editorResult',false,mes);
            var treeJson =`@Html(stackData)`;
            var treeObj = JSON.parse(treeJson);
            var data = new Array(treeObj);

            if(localStorage.compile=="true") {
                localStorage.compile="false";
                alert("compile success");
            }

            if(localStorage.debug=="true"){
                localStorage.debug="false";
                var Range = require("ace/range").Range;
                var d = data[0];
                var codeRange = d.currentExpr.codeRange;
                var range = new Range(new Number(codeRange.begin.y-1),new Number(codeRange.begin.x), new Number(codeRange.end.y-1), new Number(codeRange.end.x+1));
                editor.getSelection().setSelectionRange(range);
                outputEditor.setValue(`@(output)`, -1);
                drawMemoryState(d);
            }

    </script>

}