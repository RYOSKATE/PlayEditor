
@*
* This template takes a single argument, a String containing a
* message to display.
*@
@(stackData:String,debugState:String,output:String,sourcetext:String)
@import play.i18n._
@*
* Call the `main` template with two arguments. The first
* argument is a `String` with the title of the page, the second
* argument is an `Html` object containing the body of the page.
*@
@main("Welcome to Play") {
    @*
    * Get an `Html` object by calling the built-in Play welcome
    * template and passing a `String` message.
    *@
    @*
    @play20.welcome(message, style = "Scala")
    *@
    @Messages.get(Lang.forCode("en"),"demopage.buttons")
    <div clsee="row">
        <div class="btn-group">
            <div class="btn-group">
                <button title="@Messages.get(Lang.forCode("en"),"tooltip.fontsize")" class="btn btn-default dropdown-toggle" data-toggle="dropdown"><i class="glyphicon glyphicon-search"></i> <span class="caret"></span></button>
                <ul class="dropdown-menu" id="font-size">
                    <li><a href="#" data-size="10">小さい</a></li>
                    <li><a href="#" data-size="12">普通</a></li>
                    <li><a href="#" data-size="14">大きい</a></li>
                </ul>
            </div>
            @*<button id="bold" class="btn btn-default"><i class="glyphicon glyphicon-bold"></i></button>*@
            @*<button id="save" class="btn btn-default"><i class="glyphicon glyphicon-floppy-save"></i></button>*@
            @*<button id="load" class="btn btn-default"><i class="glyphicon glyphicon-folder-open"></i></button>*@
            @*<button id="compile" class="btn btn-default"><i class="glyphicon glyphicon-repeat"></i></button> *@@*コンパイルしてメッセージ出力*@
            <button id="debug" title="@Messages.get(Lang.forCode("en"),"tooltip.debug")" class="btn btn-default"><i class="glyphicon glyphicon-play"></i></button>@*コンパイル済みならデバッグ開始*@
            <button id="exec" title="@Messages.get(Lang.forCode("en"),"tooltip.exec")" class="btn btn-default"><i class="glyphicon glyphicon-forward"></i></button> @*コンパイル済みなら実行*@
            <button id="step" title="@Messages.get(Lang.forCode("en"),"tooltip.step")" class="btn btn-default"><i class="glyphicon glyphicon-arrow-down"></i></button>@*デバッグ開始済みなら1ステップ進む*@
            <button id="back" title="@Messages.get(Lang.forCode("en"),"tooltip.back")" class="btn btn-default"><i class="glyphicon glyphicon-arrow-up"></i></button>@*デバッグ開始済みなら1ステップ戻る*@
            <button id="stop" title="@Messages.get(Lang.forCode("en"),"tooltip.stop")" class="btn btn-default"><i class="glyphicon glyphicon-stop"></i></button>@*デバッグ中なら停止*@
        </div>
    </div>
    <div clsee="row">
        <div class="col-lg-6 col-md-6">
            DebugStatus:@Html(debugState)<br>
            <button id="exstart">@Messages.get(Lang.forCode("en"),"expage.start")</button>
            <button id="exans">@Messages.get(Lang.forCode("en"),"expage.ans")</button>
            <br>
            <div id="description"></div>
            <div id="editorMain" style="height: 500px"></div>
            output
            <div id="output" style="height: 100px"></div>
        </div>
        <div class="col-lg-6 col-md-6">
            <canvas id="display" width="600px" height="720px"></canvas>
        </div>

        @*<div class="col-lg-12 col-md-12">*@
        @*処理の流れ<br>*@
        @*実行ボタン：JavaScriptでイベント取得。エディタ上のテキストを取得。Fromの形でPOST(JavaScript)<br>*@
        @*コントローラはポストされたデータを取得。アクション関数で文字列の処理など。(Scala,String)ビューにセット。<br>*@
        @*ビュー：生文字を取得(改行文字に注意)。JavaScriptでコメント文字など操作してセット。<br>*@
        @*</div>*@
    </div>
    <script src="@routes.Assets.versioned("javascripts/visualizer.js")" type="text/javascript"></script>
    <script>

            var exText = "@Messages.get(Lang.forCode("en"),"ex.text1")"+"<br>";
            exText += "@Messages.get(Lang.forCode("en"),"ex.text2")"+"<br>";
            exText += "@Messages.get(Lang.forCode("en"),"ex.text3")"+"<br>";
            exText += "@Messages.get(Lang.forCode("en"),"ex.text4")"+"<br>";
            exText += "@Messages.get(Lang.forCode("en"),"ex.text5")"+"<br>";
            exText += "@Messages.get(Lang.forCode("en"),"ex.text6")"+"<br>";
            exText += "@Messages.get(Lang.forCode("en"),"ex.text7")"+"<br>";

            var ex1Text  = "@Messages.get(Lang.forCode("en"),"ex1.text1")"+"<br>";
            ex1Text += "@Messages.get(Lang.forCode("en"),"ex1.text2")"+"<br>";

            var ex2Text  = "@Messages.get(Lang.forCode("en"),"ex2.text1")"+"<br>";
            ex2Text += "@Messages.get(Lang.forCode("en"),"ex2.text2")"+"<br>";
            ex2Text += "@Messages.get(Lang.forCode("en"),"ex2.text3")"+"<br>";

            var ex3Text  = "@Messages.get(Lang.forCode("en"),"ex3.text1")"+"<br>";
            ex3Text += "@Messages.get(Lang.forCode("en"),"ex3.text2")"+"<br>";
            ex3Text += "@Messages.get(Lang.forCode("en"),"ex3.text3")"+"<br>";
            ex3Text += "@Messages.get(Lang.forCode("en"),"ex3.text4")"+"<br>";

            var ex4Text  = "@Messages.get(Lang.forCode("en"),"ex4.text1")"+"<br>";
            ex4Text += "@Messages.get(Lang.forCode("en"),"ex4.text2")"+"<br>";
            ex4Text += "@Messages.get(Lang.forCode("en"),"ex4.text3")"+"<br>";
            
            if("@debugState" == "")
            {
                localStorage.currentex = "";
                localStorage.sourcefile = "#include<stdio.h>";
                //英語向け
                localStorage.sourcefile=`#include<stdio.h>
int recursiveToThree(int n){
    printf("%d th\\n", n + 1);
    if(n < 3){
        int r = recursiveToThree(n + 1);
        n = r;
    }
    return n;
}
int main(){
    int n = 0;//example of variable declaration

    n = recursiveToThree(0);//example of recursive function

    int arr[5] = {1, 2, 3};//example of array variable

    int* ptr = &arr[2];//example of pointer variable
    *ptr = 5;

    //example of dynamic memory allocation
    int* d_arry = malloc(sizeof(int) * 3);

    //example of two-dimensional dynamic array
    int* pd_arr[2];
    pd_arr[0] = malloc(sizeof(int) * 2);
    pd_arr[1] = malloc(sizeof(int) * 2);

    printf("Hello,world!\\n");//example of standard output

    //example of memory leak
    free(pd_arr[0]);
    return 0;
}`;

/*                localStorage.sourcefile=`#include<stdio.h>
int recursiveToThree(int n){
    printf("%d回目\\n", n + 1);
    if(n < 3){
        int r = recursiveToThree(n + 1);
        n = r;
    }
    return n;
}
int main(){
    int n = 0;//変数宣言の例

    n = recursiveToThree(0);//再帰関数呼び出しの例

    int arr[5] = {1, 2, 3};//配列変数の例

    int* ptr = &arr[2];//ポインタ変数の例
    *ptr = 5;

    //メモリの動的確保の例
    int* d_arry = malloc(sizeof(int) * 3);

    //動的な2次元配列の例
    int* pd_arr[2];
    pd_arr[0] = malloc(sizeof(int) * 2);
    pd_arr[1] = malloc(sizeof(int) * 2);

    printf("Hello,world!\\n");//標準出力の例

    //メモリリークの例
    free(pd_arr[0]);
    return 0;
}`;*/
            }
            else if("@debugState" == "ex1" || "@debugState" == "ex2" || "@debugState" == "ex3" || "@debugState" == "ex4") {
                localStorage.currentex = "@debugState";
                localStorage.startTime = "@Messages.get(Lang.forCode("en"),"expage.start")";
                localStorage.sourcefile = "";
                localStorage.debug="false";
            }

            if(localStorage.currentex == ""){
                document.getElementById("exstart").style.display = "none";
                document.getElementById("exans").style.display = "none";
                document.getElementById("description").innerHTML = "@Messages.get(Lang.forCode("en"),"demmopage.toolexplain")";
                localStorage.startTime = "";
            }
            else  if(localStorage.currentex == "ex1" || localStorage.currentex == "ex2" || localStorage.currentex == "ex3" || localStorage.currentex == "ex4") {
                if(localStorage.startTime == "@Messages.get(Lang.forCode("en"),"expage.start")" ) {
                    document.getElementById("description").innerHTML = exText;
                }
                else {
                    if(localStorage.currentex == "ex1"){
                        document.getElementById("description").innerHTML = ex1Text;
                    }
                    else if(localStorage.currentex == "ex2"){
                        document.getElementById("description").innerHTML = ex2Text;
                    }
                    else if(localStorage.currentex == "ex3"){
                        document.getElementById("description").innerHTML = ex3Text;
                    }
                    else if(localStorage.currentex == "ex4"){
                        document.getElementById("description").innerHTML = ex4Text;
                    }
                }
            }

            $('#exstart').click(function (e) {
                var jikan= new Date();

                //時・分・秒を取得する
                var hour = jikan.getHours();
                var minute = jikan.getMinutes();
                var second = jikan.getSeconds();
                localStorage.startTime = hour+"@Messages.get(Lang.forCode("en"),"time.h")"
                        +minute+"@Messages.get(Lang.forCode("en"),"time.m")"
                        +second+"@Messages.get(Lang.forCode("en"),"time.s")";
                document.getElementById("exstart").innerHTML = localStorage.startTime;
                document.getElementById("exstart").disabled = "true";
                var text = "";
                if("@debugState" == "ex1")
                {
                    document.getElementById("description").innerHTML = ex1Text;
                    localStorage.currentex = "ex1";
                    text = `void swap1(int* x, int* y){
    int s = *x;
    if(s<2){
        *x = *y;
        *y = s;
    }
}
void swap2(int *z, int *w){
    int t = *z;
    if(t<3){
        *z = *w;
        *w = t;
    }
}
void swap3(int *w, int *o){
    int u = *w;
    if(u<4){
        *w = *o;
        *o = u;
    }else{
        *o = 6;
        swap1(o,w);
    }
}
int main()
{
    int a = 1, b = 2, c = 3, d = 4, e = 5;
    swap1(&a,&b);
    swap3(&a,&c);
    swap2(&e,&b);
    swap3(&d,&e);
    swap2(&b,&c);
    swap1(&a,&d);
    return 0;
}`;
                }
                else if("@debugState" == "ex2")
                {
                    document.getElementById("description").innerHTML = ex2Text;
                    localStorage.currentex = "ex2";
                    text = `#include<stdio.h>
int f(int* pn){
    int n = (*pn);
    int r = 1;
    if(1<=n){
        (*pn) = n - 1;
        r = n * f(pn);
    }
    return r;
}
int main()
{
    int n = 4;
    int r = f(&n);
    return 0;
}`;
                }
                else if("@debugState" == "ex3")
                {
                    document.getElementById("description").innerHTML = ex3Text;
                    localStorage.currentex = "ex3";
                    text = `#include<stdio.h>
int main()
{
    int i,j,n=3;
    int*ps[3];
    for(i=0; i<n; ++i){
        ps[i]=malloc(sizeof(int)*n);
        for(j=0; j<n; ++j){
            ps[i][j]=i*i + j*j;
        }
    }
    for(i=0; i<n; ++i){
        if(ps[i][2]%2==0)
            free(ps[i]);
    }
    return 0;
}`;
                }
                else if("@debugState" == "ex4")
                {
                    document.getElementById("description").innerHTML = ex4Text;
                    localStorage.currentex = "ex4";
                    text = `#include<stdio.h>
int H(int n,char a,char b,char c)
{
    if(n>=2){
        H(n-1,a,c,b);
    }

    if(n>=2){
        H(n-1,b,a,c);
    }
    return n;
}

int main()
{
    H(4,'A','B','C');
    return 0;
}`;
                }
                else{
                    text = localStorage.sourcefile;
                }
                editor.setValue(text, -1);
                editor.setReadOnly(true);
            });
            $('#exans').click(function (e) {
                var jikan= new Date();
                var hour = jikan.getHours();
                var minute = jikan.getMinutes();
                var second = jikan.getSeconds();
                var time = hour+"@Messages.get(Lang.forCode("en"),"time.h")"
                        +minute+"@Messages.get(Lang.forCode("en"),"time.m")"
                        +second+"@Messages.get(Lang.forCode("en"),"time.s")";

                if(localStorage.currentex == "ex1"){
                    document.getElementById("exans").innerHTML = time;
                    document.getElementById("description").innerHTML += "<br><br>"+"@Messages.get(Lang.forCode("en"),"ex1.ans")"+"<br>";
                }
                else if(localStorage.currentex == "ex2"){
                    document.getElementById("exans").innerHTML = time;
                    document.getElementById("description").innerHTML += "<br><br>"+"@Messages.get(Lang.forCode("en"),"ex2.ans")"+"<br>";
                }
                else if(localStorage.currentex == "ex3"){
                    document.getElementById("exans").innerHTML = time;
                    document.getElementById("description").innerHTML += "<br><br>"+"@Messages.get(Lang.forCode("en"),"ex3.ans")"+"<br>";
                }
                else if(localStorage.currentex == "ex4"){
                    document.getElementById("exans").innerHTML = time;
                    document.getElementById("description").innerHTML += "<br><br>"+"@Messages.get(Lang.forCode("en"),"ex4.ans")"+"<br>";
                }
                document.getElementById("description").innerHTML += "@Messages.get(Lang.forCode("en"),"ex.anstext")";
            });

            document.getElementById("exstart").innerHTML = localStorage.startTime;//開始時刻更新


            function createEditor(idName,canWrite,initText) {
                var editor = ace.edit(idName);
                if (canWrite) {
                    editor.$blockScrolling = Infinity;
                    editor.setOptions({
                        enableBasicAutocompletion: true,//基本的な自動補完
                        enableSnippets: true,//スニペット
                        enableLiveAutocompletion: true//ライブ補完
                    });
                }
                editor.setTheme("ace/theme/monokai");
                editor.getSession().setMode("ace/mode/c_cpp");//シンタックスハイライトと自動補完
                //editor.getSession().setUseWrapMode(true);//true:折り返し、false:横スクロールバー


                $('#font-size').click(function (e) {
                    editor.setFontSize($(e.target).data('size'));
                });

                editor.setReadOnly(!canWrite);
                if (canWrite) {

                    function send(sendText,action,method){
                        var form = document.createElement('form');
                        document.body.appendChild(form);
                        var input = document.createElement('input');
                        input.setAttribute('type', 'hidden');
                        input.setAttribute('name', 'name');
                        input.setAttribute('value', sendText);
                        localStorage.sourcefile = sendText;
                        form.appendChild(input);
                        form.setAttribute('action', '/visualizer'+action);
                        form.setAttribute('method', method);
                        form.submit();

                    }
                    $('#compile').click(function (e) {
                        send(editor.getValue(),'/compile','POST');
                        localStorage.line = 0;
                        localStorage.compile = "true";

                    });
                    $('#debug').click(function (e) {
                        var text =editor.getValue();
                        if(text.length<=1){
                            alert("ソースコードがありません！")
                        }
                        else
                        {
                            send(text,'/debug','POST');
                            localStorage.line = 0;
                            localStorage.debug="true";
                        }
                    });

                    $('#exec').click(function (e) {
                        if(localStorage.debug=="true"){
                            send(editor.getValue(),'/exec','POST');
                        }
                        else{
                            alert("デバッグ開始ボタンを押してください");
                        }
                    });

                    $('#step').click(function (e) {
                        if(localStorage.debug=="true"){
                            send(editor.getValue(),'/step','POST');
                        }
                        else{
                            alert("デバッグ開始ボタンを押してください");
                        }
                    });
                    $('#back').click(function (e) {
                        if(localStorage.debug=="true"){
                            send(editor.getValue(),'/back','POST');
                        }
                        else{
                            alert("デバッグ開始ボタンを押してください");
                        }

                    });
                    $('#stop').click(function (e) {
                        if(localStorage.debug=="true"){
                            send(editor.getValue(),'/stop','POST');
                            localStorage.debug="false";
                            localStorage.line = 0;
                        }
                        else{
                            alert("デバッグ開始ボタンを押してください");
                        }
                    });
                }

                if (initText != '')
                    editor.setValue(initText, -1);
                return editor;
            }
            /*
             var mes =`@Html(debugState)`;
             var mes2 = '// '+ mes.replace( /<br>/g , `
             //`) ;
             */
            var text = localStorage.sourcefile;

            var editor = createEditor('editorMain',true,text);
            if(localStorage.currentex == "ex1" || localStorage.currentex == "ex2" || localStorage.currentex == "ex3" || localStorage.currentex == "ex4") {
                editor.setReadOnly(true);
            }

            var outputEditor = ace.edit("output");
            outputEditor.setReadOnly(true);
            outputEditor.setTheme("ace/theme/terminal");

            //createEditor('editorResult',false,mes);
            var treeJson =`@Html(stackData)`;
            var treeObj = JSON.parse(treeJson);
            var data = new Array(treeObj);

            if(localStorage.compile=="true") {
                localStorage.compile="false";
                alert("compile success");
            }

            if(localStorage.debug=="true"){
                document.getElementById("exstart").disabled = "true";
                var Range = require("ace/range").Range;
                var d = data[0];
                var codeRange = d.currentExpr.codeRange;
                if(codeRange) {
                    var range = new Range(new Number(codeRange.begin.y - 1), new Number(codeRange.begin.x), new Number(codeRange.end.y - 1), new Number(codeRange.end.x + 1));
                    editor.getSelection().setSelectionRange(range);
                }
                outputEditor.setValue(`@(output)`, -1);
                drawMemoryState(d);
            }

    </script>

}