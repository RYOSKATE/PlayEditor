
@*
* This template takes a single argument, a String containing a
* message to display.
*@
@(message: String)

@*
* Call the `main` template with two arguments. The first
* argument is a `String` with the title of the page, the second
* argument is an `Html` object containing the body of the page.
*@
@main("Welcome to Play") {
    @*
    * Get an `Html` object by calling the built-in Play welcome
    * template and passing a `String` message.
    *@
    @*
    @play20.welcome(message, style = "Scala")
    *@
    <div clsee="row">
        CodeArea(ACE)
        <div class="btn-group">
            <div class="btn-group">
                <button class="btn btn-default dropdown-toggle" data-toggle="dropdown"><i class="glyphicon glyphicon-search"></i> <span class="caret"></span></button>
                <ul class="dropdown-menu" id="font-size">
                    <li><a href="#" data-size="10">小さい</a></li>
                    <li><a href="#" data-size="12">普通</a></li>
                    <li><a href="#" data-size="14">大きい</a></li>
                </ul>
            </div>
            @*<button id="bold" class="btn btn-default"><i class="glyphicon glyphicon-bold"></i></button>*@
            @*<button id="save" class="btn btn-default"><i class="glyphicon glyphicon-floppy-save"></i></button>*@
            @*<button id="load" class="btn btn-default"><i class="glyphicon glyphicon-folder-open"></i></button>*@
            <button id="exec" class="btn btn-default"><i class="glyphicon glyphicon-play"></i></button>
            <button id="step" class="btn btn-default"><i class="glyphicon glyphicon-arrow-down"></i></button>
        </div>
    </div>
    <div clsee="row">
    <div class="col-lg-6 col-md-6">
        before
        <div id="editorMain" style="height: 600px"></div>
    </div>
    <div class="col-lg-6 col-md-6">
        <canvas width=600px height="720px"></canvas>
    </div>
    <div class="col-lg-12 col-md-12">
    処理の流れ<br>
    実行ボタン：JavaScriptでイベント取得。エディタ上のテキストを取得。Fromの形でPOST(JavaScript)<br>
    コントローラはポストされたデータを取得。アクション関数で文字列の処理など。(Scala,String)ビューにセット。<br>
    ビュー：生文字を取得(改行文字に注意)。JavaScriptでコメント文字など操作してセット。<br>
    </div>
    </div>
    <script>
        function createEditor(idName,canWrite,initText) {
            var editor = ace.edit(idName);
            if (canWrite) {
                editor.$blockScrolling = Infinity;
                editor.setOptions({
                    enableBasicAutocompletion: true,//基本的な自動補完
                    enableSnippets: true,//スニペット
                    enableLiveAutocompletion: true//ライブ補完
                });
            }
            editor.setTheme("ace/theme/monokai");
            editor.getSession().setMode("ace/mode/c_cpp");//シンタックスハイライトと自動補完
            //editor.getSession().setUseWrapMode(true);//true:折り返し、false:横スクロールバー


            $('#font-size').click(function (e) {
                editor.setFontSize($(e.target).data('size'));
            });

            editor.setReadOnly(!canWrite);
            if (canWrite) {
                $('#exec').click(function (e) {
                    var form = document.createElement('form');
                    document.body.appendChild(form);
                    var input = document.createElement('input');
                    input.setAttribute('type', 'hidden');
                    input.setAttribute('name', 'name');
                    var text = editor.getValue();//ここでは生文字の改行だがPOSTしてコントローラーでは改行文字になっている。
                    localStorage.text = text;
                    var ln = `
`;
                    var regExp = new RegExp( ln, "g" ) ;
                    var text = text.replace(regExp, ' ') ;//エディタの改行は全て空白に置換する
                    input.setAttribute('value', text);
                    form.appendChild(input);
                    form.setAttribute('action', '/visualizer');
                    form.setAttribute('method', 'POST');
                    form.submit();
                });

                $('#step').click(function (e) {
                    //var obj = editor.getCursorPosition();
                    //var pos = editor.getCursorPositionScreen();
                    var curpos = editor.getSelection().getCursor();
                    editor.gotoLine(curpos.row+2 , curpos.column); //1行列目が1
                });
            }

            if (initText != '')
                editor.setValue(initText, -1);
        }
/*
        var mes =`@Html(message)`;
        var mes2 = '// '+ mes.replace( /<br>/g , `
//`) ;
*/
        createEditor('editorMain',true,localStorage.text);
        //createEditor('editorResult',false,mes);








        var memory = [];
        memory.push(new segment("データ"));//0
        memory.push(new segment("ヒープ"));//1
        memory.push(new segment("main"));//2
        memory[2].add("int","a","1");
        memory[2].add("int","b","2");
        memory[2].add("int","c","3");
        memory[2].add("int","d","4");

        memory.push(new segment("add"));//3
        memory[3].add("int","x","1");
        memory[3].add("int","y","2");

        function segment(name)
        {
            this.name=name;//データ、ヒープ、main,addなど
            this.variables = [];//変数が順番に入っていく
            this.add = function(type_,name_,value_)
            {
                this.variables.push(new variable(type_,name_,value_));//3
            }
        }
        function variable(type,name,value)
        {
            this.type = type;//"int"
            this.name = name;//"a"
            this.value = value;//"3"
        }




        $.jCanvas.defaults.fromCenter = false;
        $.jCanvas.defaults.layer = true;

        //$("canvas").drawXXXX したものはnameプロパティを設定しておくと$("canvas").getLayer(name)で取得できる
        function drawText(text, x, y, name, groupname) {
            $("canvas").drawText({
                fillStyle: "black",
                strokeStyle: "black",
                strokeWidth: "0.5",
                x: x,
                y: y,
                fontSize: 14,
                fontFamily: "sans-serif",
                text: text,
                name: name + "-text",
                draggable: true,
                groups: [groupname],
                dragGroups: [groupname]
            });
        }

        var origin = new Victor(50, 50);//図形描画の基準位置
        var nextPos = origin.clone();//次のRectの左上の位置
        function drawSegment(mem)
        {
            var pos = nextPos.clone();//次の変数の左上の位置
            var name = mem.name;//nameはその関数名とか
            var variables = mem.variables;
            var len=variables.length;
            if (0 < len)//そのスタック内の変数を全て描画
            {
                drawText(name, pos.x,pos.y, name, name);
                var borderWidth = $("canvas").getLayer(name + "-text").width;
                var heightOffset = 25;
                var borderHeight = heightOffset;
                for(var i=0; i<len; ++i)
                {
                    pos.addY(new Victor(0, heightOffset))
                    var v = variables[i];
                    var layerName = name+"-"+v.name;
                    drawText(v.type +" "+ v.name +" "+ v.value,  pos.x,pos.y, layerName,name);
                    borderWidth = Math.max(borderWidth, $("canvas").getLayer(layerName + "-text").width);
                    borderHeight += heightOffset;
                }
                pos.addX(new Victor(borderWidth+100,0))

                var posTopLeft = nextPos.clone().add(new Victor(-5,-5));
                $("canvas").drawRect({
                    strokeStyle: "black",
                    strokeWidth: 1,
                    x: posTopLeft.x,
                    y: posTopLeft.y,
                    width: borderWidth+10,
                    height: borderHeight,
                    draggable: true,
                    name: name +"-rect",
                    groups: [name],
                    dragGroups: [name]
                });
                var lineLeft = posTopLeft.clone();
                var lineRight = lineLeft.clone().addX(new Victor(borderWidth+10,0));
                for(var i=0; i<len; ++i)
                {
                    var start = lineLeft.addY(new Victor(0,heightOffset));
                    var end = lineRight.addY(new Victor(0,heightOffset));
                    $('canvas').drawLine({
                        strokeStyle: '#000',
                        strokeWidth: 1,
                        x1: start.x, y1: start.y,
                        x2: end.x, y2: end.y,
                        name: name+"_" + i  +"-line",
                        groups: [name],
                        dragGroups: [name]
                    });
                }
                nextPos=pos.clone();
            }
        }
        for(var i=0, len=memory.length; i<len; ++i)
        {
            drawSegment(memory[i]);//それぞれのスタックについて描画
        }
        
        $('canvas').drawQuadratic({
            strokeStyle: '#000',
            strokeWidth: 4,
            rounded: true,
            endArrow: true,
            arrowRadius: 15,
            arrowAngle: 60,
            x1: 40, y1: 160,
            cx1: 10, cy1: 120,
            x2: 40, y2: 90
        })

    </script>
}
